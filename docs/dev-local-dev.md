
## Local Development 

The following documentation will help you set up your local development environment for [Cloudbreak application](#cloudbreak-application) and [Cloudbreak Deployer](#cloudbreak-deployer).

### Cloudbreak Application

The following steps will help you set up your local development environment for Cloudbreak application.

#### Set up Local Development 

**Prerequisites**   
To use this development environment on Mac OS X, you need to have Docker and Boot2docker installed.

**Steps**  

1. The simplest way to prepare the working environment is to start the Cloudbreak application on your local machine using [Cloudbreak deployer](https://github.com/hortonworks/cloudbreak-deployer).

    >>>>TO-DO: What exactly do I need to do in the step above? Am I supposed to clone this repo? How do I "start" the Cloudbreak applicaton?

2. Create a directory which will store the necessary configuration files and dependencies of Cloudbreak deployer. This directory must be created outside of the cloned Cloudbreak git repository:

    <pre>
mkdir cbd-local</pre>

3. To start the complete Cloudbreak ecosystem on your machine, execute the following sequence of commands:

    <pre>
cd cbd-local
curl https://raw.githubusercontent.com/hortonworks/cloudbreak-deployer/master/install | sh && cbd --version
cbd update master
cbd init
cbd start</pre>

4. After running these commands, Cloudbreak is available at http://192.168.59.103:3000. For more details and config parameters please check the documentation of [Cloudbreak Deployer](https://github.com/hortonworks/cloudbreak-deployer).

    Furthermore, Cloudbreak deployer generates a `certs` directory inside the `cbd-local` directory. You will need it later when setting up the IDEA.

5. Open the `cbd-local/Profile` file with a text editor and add the CB_SCHEMA_SCRIPTS_LOCATION environment variable to configure the location of SQL scripts, which is the 'core/src/main/resources/schema' directory located in the cloned Cloudbreak git repository. Note that the full path needs to be configured and environment variables like $USER cannot be used. For example:

    <pre>
export CB_SCHEMA_SCRIPTS_LOCATION=/Users/myusername/prj/cloudbreak/core/src/main/resources/schema</pre>

**Tip**: If you need to kill a Cloudbreak container running inside the boot2docker and redirect the Cloudbreak related traffic to the Cloudbreak running in IDEA, use the following command:

<pre>
cbd util local-dev</pre>
   

#### Set up IDEA

The following steps will help you set up IDEA for the local development environment of Cloudbreak application.

**Steps**

1. Import Cloudbreak into IDEA as gradle project. Once done, import the proper code formatter by using the **File > Import Settings...** menu and selecting the `idea_settings.jar` located in the `config` directory in Cloudbreak git repository.

2. To launch the Cloudbreak application execute the `com.sequenceiq.cloudbreak.CloudbreakApplication` class with VM options. 

    The `FULL_PATH_OF_THE_CERTS_DIR_GENERATED_BY_CBD` below needs to be replaced with the full path of `certs` directory generated by Cloudbreak deployer; for example: `-Dcb.cert.dir=/Users/myusername/prj/cbd-local/certs`.

     <pre>
-XX:MaxPermSize=1024m
-Dcb.cert.dir=FULL_PATH_OF_THE_CERTS_DIR_GENERATED_BY_CBD
-Dcb.client.id=cloudbreak
-Dcb.client.secret=cbsecret2015
-Dcb.db.port.5432.tcp.addr=192.168.59.103
-Dcb.db.port.5432.tcp.port=5432
-Dspring.cloud.consul.host=192.168.59.103
-Dcb.identity.server.url=http://192.168.59.103:8089
-Dserver.port=9091</pre>


#### Set up Command line

The following steps will help you set up the command line for the local development environment of Cloudbreak application..

**Steps**

1. To run Cloudbreak from command line, create a property file, for example "application.properties", with the content below
    <pre>
cb.cert.dir=FULL_PATH_OF_THE_CERTS_DIR_GENERATED_BY_CBD
cb.client.id=cloudbreak
cb.client.secret=cbsecret2015
cb.db.port.5432.tcp.addr=192.168.59.103
cb.db.port.5432.tcp.port=5432
spring.cloud.consul.host=192.168.59.103
cb.identity.server.url=http://192.168.59.103:8089
server.port=9091</pre>

2. Execute the `./gradlew bootRun -Dspring.config.location=file:/path/of/property/application.properties` command at project root.

    >>>>TO-DO: Do you mean "at the project's root directory" or "as the root user"? 


#### Set up Database Development

If schema change is required in Cloudbreak database (cbdb), then the developer needs to write SQL scripts to migrate the database accordingly. In Cloudbreak, the schema migration is managed by the [MYBATIS Migrations](https://github.com/mybatis/migrations), for which the cbd tool provides an easy-to-use wrapper. The syntax for using the migration commands is 

```cbd migrate <database name> <command> [parameters]```

For example:

```cbd migrate migrate status```


**Steps**

1. Create a SQL template for schema changes:

    <pre>
cbd migrate cbdb new "CLOUD-123 schema change for new feature"
</pre>

    As as result of the above command, an SQL file template is generated under the path specified in `CB_SCHEMA_SCRIPTS_LOCATION` environment variable, which is defined in Profile. The structure of the generated SQL template looks like the following:

    <pre>
    -- // CLOUD-123 schema change for new feature
    -- Migration SQL that makes the change goes here.


    -- //@UNDO
    -- SQL to undo the change goes here.
</pre>

2. Once you have implemented your SQLs, you can execute them by using:

    <pre>
cbd migrate cbdb up
</pre>

**Optional Steps**

If you would like to rollback the last SQL file, use the `down` command:

<pre>
cbd migrate cbdb down</pre>

In order to check the status of database, use: 
```
cbd migrate cbdb status

#Every script that has not been executed will be marked as ...pending... in the output of status command:

------------------------------------------------------------------------
-- MyBatis Migrations - status
------------------------------------------------------------------------
ID             Applied At          Description
================================================================================
20150421140021 2015-07-08 10:04:28 create changelog
20150421150000 2015-07-08 10:04:28 CLOUD-607 create baseline schema
20150507121756 2015-07-08 10:04:28 CLOUD-576 change instancegrouptype hostgroup to core
20151008090632    ...pending...    CLOUD-123 schema change for new feature

------------------------------------------------------------------------
```

#### Building

Cloudbreak uses Gradle for build and dependency management. Gradle wrapper is added to Cloudbreak git repository, therefore you build by using the following command:

<pre>
./gradlew clean build
</pre>

### Cloudbreak Deployer

The following steps will help you set up your local development environment for Cloudbreak deployer.

#### Contributing

When developing, work on separate branches and then open a pull request.

>>>>TO-DO: Branching from master or from the latest released branch?

To build the project for the first time, use:

<pre>
make deps

make install
</pre>

> You only need to run `make deps` once.

To build the project, use:

<pre>
make install
</pre>

To run the unit tests, use:

<pre>
make tests
</pre>

To test the binary CircleCI build from your branch named `fix-something`, to validate the PR binary `cbd` tool will be tested. It is built by CircleCI for each branch.

>>>>TO-DO: Can you rephrase the paragraph above? I don't understand it at all. 

<pre>
cbd update fix-something
</pre>

#### Taking Snapshots

We recommend to always use the latest release.

>>>>TO-DO: How is this recommendation related to taking snapshots?

All successful builds from the `master` branch are uploaded to the public S3 bucket. You can download a build using:

>>>>TO-DO: How is this related to taking snapshots?

<pre>
curl -L s3.amazonaws.com/public-repo-1.hortonworks.com/HDP/cloudbreak/cloudbreak-deployer_snapshot_$(uname)_x86_64.tgz | tar -xz
</pre>

Instead of overwriting the released version, download it to a local directory and use it by referring to it as `./cbd`

>>>>TO-DO: How is this related to taking snapshots?

<pre>
./cbd --version
</pre>

#### Testing

Shell scripts shouldn’t raise exceptions when it comes to unit testing. 

[basht](https://github.com/progrium/basht) is
 used for testing. See [why not bats or shunit2](https://github.com/progrium/basht#why-not-bats-or-shunit2).
 
 >>>>TO-DO: Do you mean "Shell scripts shouldn’t raise exceptions **during** unit testing."?

Cover your bash functions with unit tests and run tests using:

<pre>
make tests
</pre>

#### Clodbreak Deployer Release Process 

The master branch is always built on [CircleCI](https://circleci.com/gh/hortonworks/cloudbreak-deployer).

To create a new release, all you have to do is run:

<pre>
make release-next-ver
</pre>

This performs the following steps:

 * On the `master` branch:
    * Updates the `VERSION` file by increasing the **patch** version number (for example, from 0.5.2 to 0.5.3).
    * Updates `CHANGELOG.md` with the release date.
    * Creates a new **Unreleased** section at the top of `CHANGELOG.md`.
 * Creates a pull request for the release branch:
    * Creates a new branch with a name like `release-0.5.x`. This branch should be the same as `origin/master`.
    * Creates a pull request to the `release` branch.

#### Acceptance

You can get the release by using `cbd update release-x.y.z`. 
Test it and when done, comment using "LGTM" (Looking Good To Me).

Once the PR is merged, CircleCI will:

* Create a new release on [GitHub releases tab](https://github.com/hortonworks/cloudbreak-deployer/releases), with the
 help of [gh-release](https://github.com/progrium/gh-release)
* Create the git tag with `v` prefix such as `v0.0.3`